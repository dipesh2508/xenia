{"version":3,"sources":["../src/utils/prisma.ts","../src/utils/generateToken.ts","../src/controllers/user.controller.ts","../src/middleware/isUserLoggedIn.ts","../src/routes/user.route.ts","../src/utils/cloudinary.ts","../src/controllers/community.controller.ts","../src/routes/community.route.ts","../../../packages/database/index.ts","../src/controllers/chat.controller.ts","../src/services/socket.ts","../src/controllers/message.controller.ts","../src/routes/chat.route.ts","../src/app.ts","../src/index.ts"],"names":["PrismaClient","jwt","bcrypt","express","cloudinary","CloudinaryStorage","multer","router","prisma","verify","server","Server","dotenv","path","cookieParser","cors","http"],"mappings":"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","file":"index.js","sourcesContent":["import { PrismaClient } from '@prisma/client';\r\n\r\n// Create a singleton instance of PrismaClient\r\nclass PrismaManager {\r\n  private static instance: PrismaClient;\r\n  private static isConnecting: boolean = false;\r\n  private static reconnectAttempts: number = 0;\r\n  private static readonly MAX_RECONNECT_ATTEMPTS = 5;\r\n  private static readonly RECONNECT_INTERVAL = 5000; // 5 seconds\r\n\r\n  static getInstance(): PrismaClient {\r\n    if (!PrismaManager.instance) {\r\n      console.log('Initializing PrismaClient...');\r\n      PrismaManager.instance = new PrismaClient({\r\n        log: process.env.NODE_ENV === 'development' ? ['error', 'warn'] : ['error'],\r\n        errorFormat: 'pretty'\r\n      });\r\n\r\n      // Add middleware for connection error handling\r\n      PrismaManager.instance.$use(async (params, next) => {\r\n        try {\r\n          return await next(params);\r\n        } catch (error: any) {\r\n          // Check if it's a connection error\r\n          if (\r\n            error.message.includes('Can\\'t reach database server') ||\r\n            error.message.includes('Connection refused') ||\r\n            error.message.includes('Connection lost') ||\r\n            error.message.includes('ECONNREFUSED')\r\n          ) {\r\n            console.error(`Database connection error: ${error.message}`);\r\n            \r\n            // Only attempt reconnection if we're not already trying\r\n            if (!PrismaManager.isConnecting) {\r\n              PrismaManager.attemptReconnection();\r\n            }\r\n          }\r\n          \r\n          throw error;\r\n        }\r\n      });\r\n\r\n      // Connect on initialization\r\n      PrismaManager.connect();\r\n    }\r\n    \r\n    return PrismaManager.instance;\r\n  }\r\n\r\n  private static async connect() {\r\n    try {\r\n      await PrismaManager.instance.$connect();\r\n      console.log('Database connection established successfully');\r\n      PrismaManager.reconnectAttempts = 0;\r\n    } catch (error) {\r\n      console.error('Failed to connect to the database:', error);\r\n      PrismaManager.attemptReconnection();\r\n    }\r\n  }\r\n\r\n  private static attemptReconnection() {\r\n    if (PrismaManager.reconnectAttempts >= PrismaManager.MAX_RECONNECT_ATTEMPTS) {\r\n      console.error(`Maximum reconnection attempts (${PrismaManager.MAX_RECONNECT_ATTEMPTS}) reached. Giving up.`);\r\n      return;\r\n    }\r\n\r\n    PrismaManager.isConnecting = true;\r\n    PrismaManager.reconnectAttempts++;\r\n    \r\n    console.log(`Attempting to reconnect to database (attempt ${PrismaManager.reconnectAttempts} of ${PrismaManager.MAX_RECONNECT_ATTEMPTS})...`);\r\n    \r\n    setTimeout(async () => {\r\n      try {\r\n        await PrismaManager.instance.$disconnect();\r\n        await PrismaManager.instance.$connect();\r\n        console.log('Successfully reconnected to the database');\r\n        PrismaManager.isConnecting = false;\r\n        PrismaManager.reconnectAttempts = 0;\r\n      } catch (error) {\r\n        console.error('Failed to reconnect:', error);\r\n        PrismaManager.isConnecting = false;\r\n        PrismaManager.attemptReconnection();\r\n      }\r\n    }, PrismaManager.RECONNECT_INTERVAL);\r\n  }\r\n\r\n  static async disconnect() {\r\n    if (PrismaManager.instance) {\r\n      await PrismaManager.instance.$disconnect();\r\n      console.log('Database connection closed');\r\n    }\r\n  }\r\n}\r\n\r\n// Create a single instance to export\r\nconst prisma = PrismaManager.getInstance();\r\n\r\n// Export the health check function for the database\r\nexport const checkDatabaseConnection = async (): Promise<boolean> => {\r\n  try {\r\n    // Simple query to check if the database is responsive\r\n    await prisma.$queryRaw`SELECT 1`;\r\n    return true;\r\n  } catch (error) {\r\n    console.error('Database health check failed:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\nexport { prisma, PrismaClient };","import jwt from \"jsonwebtoken\";\r\nimport { User } from \"@/types\";\r\nimport { Response } from \"express\";\r\n\r\n/**\r\n * Generates a JWT token and sets it as a cookie in the response\r\n * \r\n * @param userId The ID of the user to generate a token for\r\n * @param res Express response object to set the cookie on\r\n */\r\nexport const generateJwtToken = (userId: User[\"id\"], res?: Response): string => {\r\n  const token = jwt.sign({ id: userId }, process.env.JWT_SECRET!, {\r\n    expiresIn: '30d',\r\n  });\r\n\r\n  if (res) {\r\n    res.cookie('token', token, {\r\n      httpOnly: true,\r\n      secure: process.env.NODE_ENV === 'production',\r\n      sameSite: 'strict',\r\n      maxAge: 30 * 24 * 60 * 60 * 1000, // 30 days\r\n    });\r\n  }\r\n\r\n  return token;\r\n};\r\n","import { Request, Response } from \"express\";\r\nimport { prisma } from \"@/utils/prisma\";\r\nimport bcrypt from \"bcrypt\";\r\nimport { generateJwtToken } from \"@/utils/generateToken\";\r\n\r\nexport const userSignup = async (req: Request, res: Response): Promise<void> => {\r\n  const { name, email, password } = req.body;\r\n\r\n  try {\r\n    if (!name || !email || !password) {\r\n      res.status(400).json({\r\n        message: \"Please provide all fields.\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    if (password?.length < 6) {\r\n      res.status(400).json({\r\n        message: \"Password must be at least 6 characters.\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Check for existing user first\r\n    const existingUser = await prisma.user.findUnique({\r\n      where: { email },\r\n    });\r\n\r\n    if (existingUser) {\r\n      res.status(400).json({\r\n        message: \"User with the provided email already exist.\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    const salt = await bcrypt.genSalt(10);\r\n    const hashedPassword = await bcrypt.hash(password, salt);\r\n\r\n    const newUser = await prisma.user.create({\r\n      data: {\r\n        name,\r\n        email,\r\n        password: hashedPassword,\r\n      },\r\n      select: {\r\n        id: true,\r\n        name: true,\r\n        email: true\r\n      }\r\n    });\r\n\r\n    // Updated cookie settings\r\n    const token = generateJwtToken(newUser.id);\r\n    res.cookie(\"token\", token, {\r\n      httpOnly: true,\r\n      secure: process.env.NODE_ENV === \"production\",\r\n      sameSite: process.env.NODE_ENV === \"production\" ? \"none\" : \"lax\",\r\n      maxAge: 30 * 24 * 60 * 60 * 1000, // 30 days\r\n      path: \"/\"\r\n    });\r\n\r\n    res.status(201).json(newUser);\r\n  } catch (error) {\r\n    console.error(\"Signup Error:\", error);\r\n    res.status(500).json({\r\n      message: \"Internal server error.\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const userLogin = async (req: Request, res: Response): Promise<void> => {\r\n  const { email, password } = req.body;\r\n\r\n  try {\r\n    if (!email || !password) {\r\n      res.status(400).json({\r\n        message: \"Please provide all fields.\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    const user = await prisma.user.findUnique({\r\n      where: { email },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        name: true,\r\n        password: true,\r\n      },\r\n    });\r\n\r\n    if (!user || !user.password) {\r\n      res.status(400).json({\r\n        message: \"Invalid credentials.\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    const isMatch = await bcrypt.compare(password, user.password);\r\n\r\n    if (!isMatch) {\r\n      res.status(400).json({\r\n        message: \"Invalid credentials.\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Generate token first\r\n    const token = generateJwtToken(user.id);\r\n    res.cookie(\"token\", token, {\r\n      httpOnly: true,\r\n      secure: process.env.NODE_ENV === \"production\",\r\n      sameSite: process.env.NODE_ENV === \"production\" ? \"none\" : \"lax\",\r\n      maxAge: 30 * 24 * 60 * 60 * 1000, // 30 days\r\n      path: \"/\"\r\n    });\r\n\r\n    // Then send response without password\r\n    res.status(200).json({\r\n      id: user.id,\r\n      name: user.name,\r\n      email: user.email,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Login Error:\", error);\r\n    res.status(500).json({\r\n      message: \"Internal server error.\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const logout = async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    res.clearCookie(\"token\", {\r\n      httpOnly: true,\r\n      secure: process.env.NODE_ENV === \"production\",\r\n      sameSite: process.env.NODE_ENV === \"production\" ? \"none\" : \"lax\",\r\n      path: \"/\"\r\n    });\r\n    res.status(200).json({\r\n      message: \"Logged out successfully.\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Logout Error:\", error);\r\n    res.status(500).json({\r\n      message: \"Internal server error.\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const checkAuth = async (req: any, res: Response): Promise<void> => {\r\n  try {\r\n    res.status(200).json(req.user);\r\n  } catch (error) {\r\n    console.error(\"CheckAuth Error:\", error);\r\n    res.status(500).json({\r\n      message: \"Internal server error.\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const deleteUser = async (req: Request, res: Response): Promise<void> => {\r\n  const userId = req.params.id;\r\n\r\n  try {\r\n    const deletedUser = await prisma.user.delete({\r\n      where: {\r\n        id: userId,\r\n      },\r\n    });\r\n\r\n    if (!deletedUser) {\r\n      res.status(404).json({\r\n        message: \"User not found.\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    res.status(200).json({\r\n      message: \"User deleted successfully.\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Delete User Error:\", error);\r\n    res.status(500).json({\r\n      message: \"Internal server error.\",\r\n    });\r\n  }\r\n};\r\n","import { prisma } from \"@/utils/prisma\";\r\nimport { User } from \"@/types\";\r\nimport { Request, Response, NextFunction } from \"express\";\r\nimport jwt from \"jsonwebtoken\";\r\n\r\nexport const isLoggedIn = async (\r\n  req: any,\r\n  res: Response,\r\n  next: NextFunction\r\n): Promise<any> => {\r\n  const token = req.cookies.token;\r\n\r\n  if (!token) {\r\n    console.error(\"No token found in cookies\");\r\n    return res.status(401).json({\r\n      message: \"Unauthorized\",\r\n    });\r\n  }\r\n\r\n  try {\r\n    if (!process.env.JWT_SECRET) {\r\n      console.error(\"Critical environment variable JWT_SECRET is missing!\");\r\n      throw new Error(\"JWT_SECRET is not defined\");\r\n    }\r\n\r\n    const decoded = jwt.verify(token, process.env.JWT_SECRET) as {\r\n      id: User[\"id\"];\r\n    };\r\n\r\n    if (!decoded.id) {\r\n      console.error(\"Decoded id is missing from token\");\r\n      return res.status(401).json({\r\n        message: \"Unauthorized\",\r\n      });\r\n    }\r\n\r\n    try {\r\n      const user = await prisma.user.findUnique({\r\n        where: {\r\n          id: decoded.id,\r\n        },\r\n        select: {\r\n          id: true,\r\n          name: true,\r\n          email: true,\r\n          image: true,\r\n        },\r\n      });\r\n\r\n      if (!user) {\r\n        console.error(\"User not found in database\");\r\n        return res.status(401).json({\r\n          message: \"User not found.\",\r\n        });\r\n      }\r\n\r\n      req.user = user;\r\n      next();\r\n    } catch (dbError) {\r\n      console.error(\"Database error during authentication:\", dbError);\r\n      return res.status(503).json({\r\n        message: \"Service temporarily unavailable. Please try again later.\",\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Authentication Error:\", error);\r\n    return res.status(401).json({\r\n      message: \"Authentication failed. Please log in again.\",\r\n    });\r\n  }\r\n};\r\n","import express from \"express\";\r\nimport {\r\n  checkAuth,\r\n  userLogin,\r\n  userSignup,\r\n  logout,\r\n  deleteUser\r\n} from \"@/controllers/user.controller\";\r\nimport { isLoggedIn } from \"@/middleware/isUserLoggedIn\";\r\n\r\nconst router = express.Router();\r\n\r\nrouter.route(\"/signup\").post(userSignup);\r\nrouter.route(\"/login\").post(userLogin);\r\nrouter.route(\"/logout\").post(logout);\r\nrouter.route(\"/checkAuth\").get(isLoggedIn, checkAuth);\r\nrouter.route(\"/:id\").delete(isLoggedIn, deleteUser);\r\n\r\nexport default router;\r\n","import { v2 as cloudinary } from 'cloudinary';\r\nimport { CloudinaryStorage } from 'multer-storage-cloudinary';\r\nimport multer from 'multer';\r\n\r\ncloudinary.config({\r\n  cloud_name: process.env.CLOUDINARY_CLOUD_NAME,\r\n  api_key: process.env.CLOUDINARY_API_KEY,\r\n  api_secret: process.env.CLOUDINARY_API_SECRET,\r\n});\r\n\r\nconst storage = new CloudinaryStorage({\r\n  cloudinary: cloudinary,\r\n  params: {\r\n    folder: 'xenia-communities',\r\n    allowed_formats: ['jpg', 'jpeg', 'png', 'gif', 'webp'],\r\n    transformation: [{ width: 500, height: 500, crop: 'limit' }],\r\n  } as any\r\n});\r\n\r\nconst uploadMiddleware = multer({ \r\n  storage: storage,\r\n  limits: {\r\n    fileSize: 5 * 1024 * 1024, // 5MB max file size\r\n  }\r\n});\r\n\r\n// Create an upload object with optional method - fix the implementation\r\nexport const upload = {\r\n  single: (fieldName: string) => uploadMiddleware.single(fieldName),\r\n  optional: function() {\r\n    return {\r\n      single: (fieldName: string) => (req: any, res: any, next: any) => {\r\n        // If there's no file, bypass multer\r\n        if (!req.file && (!req.files || Object.keys(req.files).length === 0)) {\r\n          return next();\r\n        }\r\n        \r\n        // Use multer to handle the file upload\r\n        uploadMiddleware.single(fieldName)(req, res, (err: any) => {\r\n          if (err) {\r\n            console.error('Multer error:', err);\r\n            return res.status(400).json({ message: err.message });\r\n          }\r\n          next();\r\n        });\r\n      }\r\n    };\r\n  }\r\n};\r\n\r\nexport const deleteImage = async (publicId: string) => {\r\n  try {\r\n    await cloudinary.uploader.destroy(publicId);\r\n    console.log(`Successfully deleted image: ${publicId}`);\r\n  } catch (error) {\r\n    console.error('Error deleting image from Cloudinary:', error);\r\n  }\r\n};\r\n\r\nexport const getPublicIdFromUrl = (url: string) => {\r\n  const splits = url.split('/');\r\n  const filename = splits[splits.length - 1] || '';\r\n  return `xenia-communities/${filename.split('.')[0]}`;\r\n};\r\n","import { Request, Response } from \"express\";\r\nimport { prisma } from \"@/utils/prisma\";\r\nimport { deleteImage, getPublicIdFromUrl } from \"@/utils/cloudinary\";\r\n\r\nexport const createCommunity = async (\r\n  req: any,\r\n  res: Response\r\n): Promise<void> => {\r\n  try {\r\n    const { name, description } = req.body;\r\n    const userId = req.user.id;\r\n\r\n    if (!name) {\r\n      res.status(400).json({ message: \"Community name is required\" });\r\n      return;\r\n    }\r\n\r\n    if (name.length > 100) {\r\n      res\r\n        .status(400)\r\n        .json({ message: \"Community name must be less than 100 characters\" });\r\n      return;\r\n    }\r\n\r\n    // Check for existing community with same name\r\n    const existingCommunity = await prisma.community.findFirst({\r\n      where: { name },\r\n    });\r\n\r\n    if (existingCommunity) {\r\n      res.status(400).json({ message: \"Community name already exists\" });\r\n      return;\r\n    }\r\n\r\n    // Create community and automatically create a chat room for it\r\n    const community = await prisma.$transaction(async (tx) => {\r\n      // Create the community\r\n      const newCommunity = await tx.community.create({\r\n        data: {\r\n          name,\r\n          description,\r\n          ...(req.file?.path && { image: req.file.path }),\r\n          ownerId: userId,\r\n          members: {\r\n            create: {\r\n              userId,\r\n              role: \"OWNER\",\r\n            },\r\n          },\r\n        },\r\n      });\r\n\r\n      // Create a default chat room for the community\r\n      await tx.chat.create({\r\n        data: {\r\n          communityId: newCommunity.id,\r\n        },\r\n      });\r\n\r\n      return newCommunity;\r\n    });\r\n\r\n    res.status(201).json(community);\r\n  } catch (error) {\r\n    console.error(\"Create Community Error:\", error);\r\n    res.status(500).json({ message: \"Internal server error\" });\r\n  }\r\n};\r\n\r\nexport const getCommunity = async (\r\n  req: Request,\r\n  res: Response\r\n): Promise<void> => {\r\n  try {\r\n    const { id } = req.params;\r\n\r\n    const community = await prisma.community.findUnique({\r\n      where: { id },\r\n      include: {\r\n        owner: {\r\n          select: {\r\n            id: true,\r\n            name: true,\r\n            email: true,\r\n            image: true,\r\n          },\r\n        },\r\n        chats: {\r\n          include: {\r\n            _count: {\r\n              select: {\r\n                messages: true\r\n              }\r\n            },\r\n            messages: {\r\n              take: 20,\r\n              orderBy: {\r\n                createdAt: \"desc\",\r\n              },\r\n              include: {\r\n                sender: {\r\n                  select: {\r\n                    id: true,\r\n                    name: true,\r\n                  },\r\n                },\r\n              },\r\n            },\r\n          },\r\n        },\r\n      }\r\n    });\r\n\r\n    if (!community) {\r\n      res.status(404).json({ message: \"Community not found\" });\r\n      return;\r\n    }\r\n\r\n    res.status(200).json(community);\r\n  } catch (error) {\r\n    console.error(\"Get Community Error:\", error);\r\n    res.status(500).json({ message: \"Internal server error\" });\r\n  }\r\n};\r\n\r\nexport const getAllCommunities = async (\r\n  req: Request,\r\n  res: Response\r\n): Promise<void> => {\r\n  try {\r\n    const page = parseInt(req.query.page as string) || 1;\r\n    const limit = parseInt(req.query.limit as string) || 10;\r\n    const search = req.query.search as string;\r\n    const skip = (page - 1) * limit;\r\n\r\n    const where = search\r\n      ? {\r\n          name: {\r\n            contains: search,\r\n            mode: \"insensitive\" as const,\r\n          },\r\n        }\r\n      : {};\r\n\r\n    if (req.query.page || req.query.limit || req.query.search) {\r\n      // Return paginated response when query params are present\r\n      const [communities, total] = await Promise.all([\r\n        prisma.community.findMany({\r\n          where,\r\n          skip,\r\n          take: limit,\r\n          include: {\r\n            owner: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                image: true,\r\n              },\r\n            },\r\n            _count: {\r\n              select: {\r\n                members: true,\r\n              },\r\n            },\r\n          },\r\n        }),\r\n        prisma.community.count({ where }),\r\n      ]);\r\n\r\n      res.status(200).json({\r\n        communities,\r\n        total,\r\n        hasMore: total > skip + limit,\r\n      });\r\n    } else {\r\n      // Return all communities when no query params are present\r\n      const communities = await prisma.community.findMany({\r\n        include: {\r\n          owner: {\r\n            select: {\r\n              id: true,\r\n              name: true,\r\n              image: true,\r\n            },\r\n          },\r\n          _count: {\r\n            select: {\r\n              members: true,\r\n            },\r\n          },\r\n        },\r\n      });\r\n\r\n      res.status(200).json(communities);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Get All Communities Error:\", error);\r\n    res.status(500).json({ message: \"Internal server error\" });\r\n  }\r\n};\r\n\r\nexport const updateCommunity = async (\r\n  req: any,\r\n  res: Response\r\n): Promise<void> => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { name, description } = req.body;\r\n    const userId = req.user.id;\r\n\r\n    const community = await prisma.community.findUnique({\r\n      where: { id },\r\n    });\r\n\r\n    if (!community) {\r\n      res.status(404).json({ message: \"Community not found\" });\r\n      return;\r\n    }\r\n\r\n    if (community.ownerId !== userId) {\r\n      res\r\n        .status(403)\r\n        .json({ message: \"Not authorized to update this community\" });\r\n      return;\r\n    }\r\n\r\n    if (name) {\r\n      const existingCommunity = await prisma.community.findFirst({\r\n        where: {\r\n          name,\r\n          id: { not: id },\r\n        },\r\n      });\r\n\r\n      if (existingCommunity) {\r\n        res.status(400).json({ message: \"Community name already exists\" });\r\n        return;\r\n      }\r\n    }\r\n\r\n    // Only handle image deletion if a new image is being uploaded\r\n    if (req.file?.path && community.image) {\r\n      const publicId = getPublicIdFromUrl(community.image);\r\n      await deleteImage(publicId);\r\n    }\r\n\r\n    const updatedCommunity = await prisma.community.update({\r\n      where: { id },\r\n      data: {\r\n        name,\r\n        description,\r\n        ...(req.file?.path && { image: req.file.path }),\r\n      },\r\n    });\r\n\r\n    res.status(200).json(updatedCommunity);\r\n  } catch (error) {\r\n    console.error(\"Update Community Error:\", error);\r\n    res.status(500).json({ message: \"Internal server error\" });\r\n  }\r\n};\r\n\r\nexport const deleteCommunity = async (\r\n  req: any,\r\n  res: Response\r\n): Promise<void> => {\r\n  try {\r\n    const { id } = req.params;\r\n    const userId = req.user.id;\r\n\r\n    const community = await prisma.community.findUnique({\r\n      where: { id },\r\n    });\r\n\r\n    if (!community) {\r\n      res.status(404).json({ message: \"Community not found\" });\r\n      return;\r\n    }\r\n\r\n    if (community.ownerId !== userId) {\r\n      res\r\n        .status(403)\r\n        .json({ message: \"Not authorized to delete this community\" });\r\n      return;\r\n    }\r\n\r\n    // Delete community image from Cloudinary\r\n    if (community.image) {\r\n      const publicId = getPublicIdFromUrl(community.image);\r\n      await deleteImage(publicId);\r\n    }\r\n\r\n    await prisma.community.delete({\r\n      where: { id },\r\n    });\r\n\r\n    res.status(200).json({ message: \"Community deleted successfully\" });\r\n  } catch (error) {\r\n    console.error(\"Delete Community Error:\", error);\r\n    res.status(500).json({ message: \"Internal server error\" });\r\n  }\r\n};\r\n\r\nexport const joinCommunity = async (req: any, res: Response): Promise<void> => {\r\n  try {\r\n    const { id } = req.params;\r\n    const userId = req.user.id;\r\n\r\n    const community = await prisma.community.findUnique({\r\n      where: { id },\r\n      include: {\r\n        members: true,\r\n      },\r\n    });\r\n\r\n    if (!community) {\r\n      res.status(404).json({ message: \"Community not found\" });\r\n      return;\r\n    }\r\n\r\n    const existingMembership = community.members.find(\r\n      (m) => m.userId === userId\r\n    );\r\n    if (existingMembership) {\r\n      res\r\n        .status(400)\r\n        .json({ message: \"User is already a member of this community\" });\r\n      return;\r\n    }\r\n\r\n    const membership = await prisma.communitiesOnUsers.create({\r\n      data: {\r\n        communityId: id,\r\n        userId,\r\n        role: \"MEMBER\",\r\n      },\r\n    });\r\n\r\n    res.status(200).json(membership);\r\n  } catch (error) {\r\n    console.error(\"Join Community Error:\", error);\r\n    res.status(500).json({ message: \"Internal server error\" });\r\n  }\r\n};\r\n\r\nexport const leaveCommunity = async (\r\n  req: any,\r\n  res: Response\r\n): Promise<void> => {\r\n  try {\r\n    const { id } = req.params;\r\n    const userId = req.user.id;\r\n\r\n    const community = await prisma.community.findUnique({\r\n      where: { id },\r\n      include: {\r\n        members: true,\r\n      },\r\n    });\r\n\r\n    if (!community) {\r\n      res.status(404).json({ message: \"Community not found\" });\r\n      return;\r\n    }\r\n\r\n    if (community.ownerId === userId) {\r\n      res.status(400).json({ message: \"Owner cannot leave the community\" });\r\n      return;\r\n    }\r\n\r\n    const membership = community.members.find((m) => m.userId === userId);\r\n    if (!membership) {\r\n      res\r\n        .status(400)\r\n        .json({ message: \"User is not a member of this community\" });\r\n      return;\r\n    }\r\n\r\n    await prisma.communitiesOnUsers.delete({\r\n      where: {\r\n        communityId_userId: {\r\n          communityId: id,\r\n          userId,\r\n        },\r\n      },\r\n    });\r\n\r\n    res.status(200).json({ message: \"Left community successfully\" });\r\n  } catch (error) {\r\n    console.error(\"Leave Community Error:\", error);\r\n    res.status(500).json({ message: \"Internal server error\" });\r\n  }\r\n};\r\n\r\nexport const getCommunityMembers = async (\r\n  req: Request,\r\n  res: Response\r\n): Promise<void> => {\r\n  try {\r\n    const { id } = req.params;\r\n\r\n    if (req.query.page || req.query.limit) {\r\n      // Paginated response when page/limit is specified\r\n      const page = parseInt(req.query.page as string) || 1;\r\n      const limit = parseInt(req.query.limit as string) || 10;\r\n      const skip = (page - 1) * limit;\r\n\r\n      const [members, total] = await Promise.all([\r\n        prisma.communitiesOnUsers.findMany({\r\n          where: { communityId: id },\r\n          skip,\r\n          take: limit,\r\n          include: {\r\n            user: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                email: true,\r\n                image: true,\r\n              },\r\n            },\r\n          },\r\n        }),\r\n        prisma.communitiesOnUsers.count({\r\n          where: { communityId: id },\r\n        }),\r\n      ]);\r\n\r\n      res.status(200).json({\r\n        members: members.map((member) => ({\r\n          id: member.user.id,\r\n          name: member.user.name,\r\n          email: member.user.email,\r\n          image: member.user.image,\r\n          role: member.role,\r\n        })),\r\n        total,\r\n        hasMore: total > skip + limit,\r\n      });\r\n    } else {\r\n      // Simple array response for non-paginated requests (what the test expects)\r\n      const members = await prisma.communitiesOnUsers.findMany({\r\n        where: { communityId: id },\r\n        include: {\r\n          user: {\r\n            select: {\r\n              id: true,\r\n              name: true,\r\n              email: true,\r\n              image: true,\r\n            },\r\n          },\r\n        },\r\n      });\r\n\r\n      // Format the response as a flat array of user objects with roles\r\n      const formattedMembers = members.map((member) => ({\r\n        id: member.user.id,\r\n        name: member.user.name,\r\n        email: member.user.email,\r\n        image: member.user.image,\r\n        role: member.role,\r\n      }));\r\n\r\n      res.status(200).json(formattedMembers);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Get Community Members Error:\", error);\r\n    res.status(500).json({ message: \"Internal server error\" });\r\n  }\r\n};\r\n\r\nexport const getUserCommunities = async (\r\n  req: any,\r\n  res: Response\r\n): Promise<void> => {\r\n  try {\r\n    const userId = req.user.id;\r\n\r\n    if (!userId) {\r\n      res.status(401).json({ message: \"Unauthorized\" });\r\n      return;\r\n    }\r\n    const communities = await prisma.communitiesOnUsers.findMany({\r\n      where: { userId },\r\n      include: {\r\n        community: {\r\n          include: {\r\n            _count: {\r\n              select: {\r\n                members: true,\r\n              },\r\n            },\r\n            chats: {\r\n              include: {\r\n                messages: {\r\n                  take: 1,\r\n                  orderBy: {\r\n                    createdAt: \"desc\",\r\n                  },\r\n                  include: {\r\n                    sender: {\r\n                      select: {\r\n                        id: true,\r\n                        name: true,\r\n                      },\r\n                    },\r\n                  },\r\n                },\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    res.status(200).json(communities);\r\n  } catch (error) {\r\n    console.error(\"Get User Communities Error:\", error);\r\n    res.status(500).json({ message: \"Internal server error\" });\r\n  }\r\n};\r\n","import express from \"express\";\r\nimport { upload } from \"@/utils/cloudinary\";\r\nimport {\r\n  createCommunity,\r\n  getCommunity,\r\n  getAllCommunities,\r\n  updateCommunity,\r\n  deleteCommunity,\r\n  joinCommunity,\r\n  leaveCommunity,\r\n  getCommunityMembers,\r\n  getUserCommunities\r\n} from \"@/controllers/community.controller\";\r\nimport { isLoggedIn } from \"@/middleware/isUserLoggedIn\";\r\n\r\nconst router = express.Router();\r\n\r\nrouter.post(\"/\", isLoggedIn, upload.single('image'), createCommunity);\r\nrouter.get(\"/\", getAllCommunities);\r\nrouter.get(\"/user\", isLoggedIn, getUserCommunities);\r\nrouter.get(\"/:id\", getCommunity);\r\nrouter.put(\"/:id\", isLoggedIn, upload.single('image'), updateCommunity);\r\nrouter.delete(\"/:id\", isLoggedIn, deleteCommunity);\r\nrouter.post(\"/:id/join\", isLoggedIn, joinCommunity);\r\nrouter.post(\"/:id/leave\", isLoggedIn, leaveCommunity);\r\nrouter.get(\"/:id/members\", getCommunityMembers);\r\n\r\nexport default router;\r\n","import { PrismaClient } from '@prisma/client';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nexport { prisma, PrismaClient };","import { Request, Response } from \"express\";\r\nimport { prisma } from \"@repo/database\";\r\n\r\n// Create a new chat room in a community\r\nexport const createChat = async (req: any, res: Response): Promise<void> => {\r\n  try {\r\n    const { communityId } = req.body;\r\n    const userId = req.user.id;\r\n\r\n    if (!communityId) {\r\n      res.status(400).json({ message: \"Community ID is required\" });\r\n      return;\r\n    }\r\n\r\n    // Check if community exists\r\n    const community = await prisma.community.findUnique({\r\n      where: { id: communityId },\r\n      include: {\r\n        members: {\r\n          where: { userId }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!community) {\r\n      res.status(404).json({ message: \"Community not found\" });\r\n      return;\r\n    }\r\n\r\n    // Ensure user is a member of the community\r\n    if (community.members.length === 0) {\r\n      res.status(403).json({ message: \"You must be a member of the community to create a chat\" });\r\n      return;\r\n    }\r\n\r\n    // Create chat room\r\n    const newChat = await prisma.chat.create({\r\n      data: {\r\n        communityId\r\n      }\r\n    });\r\n\r\n    res.status(201).json(newChat);\r\n  } catch (error) {\r\n    console.error(\"Create Chat Error:\", error);\r\n    res.status(500).json({ message: \"Internal server error\" });\r\n  }\r\n};\r\n\r\n// Get all chat rooms for a community\r\nexport const getCommunityChats = async (req: any, res: Response): Promise<void> => {\r\n  try {\r\n    const { communityId } = req.params;\r\n    const userId = req.user.id;\r\n\r\n    // Verify community exists\r\n    const community = await prisma.community.findUnique({\r\n      where: { id: communityId },\r\n      include: {\r\n        members: {\r\n          where: { userId }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!community) {\r\n      res.status(404).json({ message: \"Community not found\" });\r\n      return;\r\n    }\r\n\r\n    // Check if user is a member of the community\r\n    const isMember = community.members.length > 0 || community.ownerId === userId;\r\n    if (!isMember) {\r\n      res.status(403).json({ message: \"You must be a member of the community to view chats\" });\r\n      return;\r\n    }\r\n\r\n    const chats = await prisma.chat.findMany({\r\n      where: {\r\n        communityId\r\n      },\r\n      orderBy: {\r\n        updatedAt: \"desc\"\r\n      },\r\n      include: {\r\n        _count: {\r\n          select: {\r\n            messages: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    res.status(200).json(chats);\r\n  } catch (error) {\r\n    console.error(\"Get Community Chats Error:\", error);\r\n    res.status(500).json({ message: \"Internal server error\" });\r\n  }\r\n};\r\n\r\n// Get a specific chat room by ID\r\nexport const getChatById = async (req: any, res: Response): Promise<void> => {\r\n  try {\r\n    const { chatId } = req.params;\r\n    const userId = req.user.id;\r\n\r\n    const chat = await prisma.chat.findUnique({\r\n      where: {\r\n        id: chatId\r\n      },\r\n      include: {\r\n        community: {\r\n          include: {\r\n            members: {\r\n              where: { userId }\r\n            }\r\n          }\r\n        },\r\n        messages: {\r\n          include: {\r\n            sender: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                image: true\r\n              }\r\n            }\r\n          },\r\n          orderBy: {\r\n            createdAt: \"asc\"\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!chat) {\r\n      res.status(404).json({ message: \"Chat room not found\" });\r\n      return;\r\n    }\r\n\r\n    // Check if user is a member of the community\r\n    const isMember = chat.community.members.length > 0 || chat.community.ownerId === userId;\r\n    if (!isMember) {\r\n      res.status(403).json({ message: \"You must be a member of the community to view this chat\" });\r\n      return;\r\n    }\r\n\r\n    res.status(200).json(chat);\r\n  } catch (error) {\r\n    console.error(\"Get Chat Error:\", error);\r\n    res.status(500).json({ message: \"Internal server error\" });\r\n  }\r\n};\r\n\r\n// Delete a chat room\r\nexport const deleteChat = async (req: any, res: Response): Promise<void> => {\r\n  try {\r\n    const { chatId } = req.params;\r\n    const userId = req.user.id;\r\n\r\n    const chat = await prisma.chat.findUnique({\r\n      where: { id: chatId },\r\n      include: {\r\n        community: true\r\n      }\r\n    });\r\n\r\n    if (!chat) {\r\n      res.status(404).json({ message: \"Chat room not found\" });\r\n      return;\r\n    }\r\n\r\n    // Only community owner or admin can delete chats\r\n    const userRole = await prisma.communitiesOnUsers.findUnique({\r\n      where: {\r\n        communityId_userId: {\r\n          communityId: chat.communityId,\r\n          userId\r\n        }\r\n      }\r\n    });\r\n\r\n    if (chat.community.ownerId !== userId && (!userRole || userRole.role !== \"ADMIN\")) {\r\n      res.status(403).json({ message: \"Not authorized to delete this chat room\" });\r\n      return;\r\n    }\r\n\r\n    // Delete the chat\r\n    await prisma.chat.delete({\r\n      where: { id: chatId }\r\n    });\r\n\r\n    res.status(200).json({ message: \"Chat room deleted successfully\" });\r\n  } catch (error) {\r\n    console.error(\"Delete Chat Error:\", error);\r\n    res.status(500).json({ message: \"Internal server error\" });\r\n  }\r\n};\r\n","import { Server as HttpServer } from 'http';\r\nimport { Server, Socket } from 'socket.io';\r\nimport { verify } from 'jsonwebtoken';\r\nimport { prisma } from '@/utils/prisma';\r\n\r\nlet io: Server;\r\n\r\n// Socket middleware to authenticate connections\r\nconst authenticateSocket = async (socket: Socket, next: (err?: Error) => void) => {\r\n  try {\r\n    // Get cookies from handshake\r\n    const cookies = socket.handshake.headers.cookie;\r\n    if (!cookies) {\r\n      return next(new Error('Authentication failed: No cookies provided'));\r\n    }\r\n    \r\n    // Parse cookies to get the JWT token\r\n    const cookieArray = cookies.split(';').map(cookie => cookie.trim());\r\n    const tokenCookie = cookieArray.find(cookie => cookie.startsWith('token='));\r\n    \r\n    if (!tokenCookie) {\r\n      return next(new Error('Authentication failed: No token cookie'));\r\n    }\r\n    \r\n    const token = tokenCookie.split('=')[1];\r\n    \r\n    // Check if JWT_SECRET exists\r\n    if (!process.env.JWT_SECRET) {\r\n      return next(new Error('JWT_SECRET is not configured'));\r\n    }\r\n\r\n    if(!token) {\r\n      return next(new Error('Authentication failed: No token provided'));\r\n    }\r\n    \r\n    // Verify the token\r\n    const decoded = verify(token, process.env.JWT_SECRET) as unknown as { id: string };\r\n    \r\n    if (!decoded || !decoded.id) {\r\n      return next(new Error('Authentication failed: Invalid token'));\r\n    }\r\n    \r\n    // Find the user\r\n    const user = await prisma.user.findUnique({\r\n      where: { id: decoded.id }\r\n    });\r\n    \r\n    if (!user) {\r\n      return next(new Error('Authentication failed: User not found'));\r\n    }\r\n    \r\n    // Attach user to socket for later use\r\n    (socket as any).user = user;\r\n    next();\r\n  } catch (error) {\r\n    console.error('Socket authentication error:', error);\r\n    next(new Error('Authentication failed'));\r\n  }\r\n};\r\n\r\nexport const initSocketServer = (server: HttpServer): void => {\r\n  // Ensure io isn't already initialized\r\n  if (io) {\r\n    console.warn('Socket.IO server already initialized');\r\n    return;\r\n  }\r\n\r\n  io = new Server(server, {\r\n    cors: {\r\n      origin: process.env.FRONTEND_URL || 'http://localhost:3000',\r\n      methods: ['GET', 'POST'],\r\n      credentials: true\r\n    },\r\n    path: '/socket.io/',\r\n    transports: ['websocket', 'polling'],\r\n    // Increase ping timeout to prevent premature disconnections\r\n    pingTimeout: 60000\r\n  });\r\n\r\n  // Apply authentication middleware\r\n  io.use(authenticateSocket);\r\n\r\n  io.on('connection', (socket: Socket) => {\r\n    console.log(`User connected: ${(socket as any).user?.id}`);\r\n    \r\n    // Join a specific chat room\r\n    socket.on('joinRoom', (roomId: string) => {\r\n      socket.join(roomId);\r\n      console.log(`User ${(socket as any).user?.id} joined room ${roomId}`);\r\n    });\r\n    \r\n    // Leave a specific chat room\r\n    socket.on('leaveRoom', (roomId: string) => {\r\n      socket.leave(roomId);\r\n      console.log(`User ${(socket as any).user?.id} left room ${roomId}`);\r\n    });\r\n    \r\n    // Handle disconnection\r\n    socket.on('disconnect', () => {\r\n      console.log(`User disconnected: ${(socket as any).user?.id}`);\r\n    });\r\n  });\r\n\r\n  console.log('Socket.IO server initialized successfully');\r\n};\r\n\r\n// Function to get the io instance\r\nexport const getIO = (): Server => {\r\n  if (!io) {\r\n    throw new Error('Socket.IO has not been initialized. Please call initSocketServer first.');\r\n  }\r\n  return io;\r\n};\r\n\r\n// Export the socket server\r\nexport { io };\r\n","import { Request, Response } from \"express\";\r\nimport { prisma } from \"@repo/database\";\r\nimport { io } from \"@/services/socket\";\r\n\r\nexport const createMessage = async (req: any, res: Response): Promise<void> => {\r\n  try {\r\n    const { content, chatId } = req.body;\r\n    const userId = req.user.id;\r\n\r\n    if (!content || !chatId) {\r\n      res.status(400).json({ message: \"Content and chat ID are required\" });\r\n      return;\r\n    }\r\n\r\n    // Verify the chat exists\r\n    const chat = await prisma.chat.findUnique({\r\n      where: { id: chatId },\r\n      include: { community: { include: { members: true } } }\r\n    });\r\n\r\n    if (!chat) {\r\n      res.status(404).json({ message: \"Chat not found\" });\r\n      return;\r\n    }\r\n\r\n    // Verify user is a member of the community\r\n    const isMember = chat.community.members.some(member => member.userId === userId);\r\n    if (!isMember) {\r\n      res.status(403).json({ message: \"You are not a member of this community\" });\r\n      return;\r\n    }\r\n\r\n    // Create the message\r\n    const message = await prisma.message.create({\r\n      data: {\r\n        content,\r\n        senderId: userId,\r\n        chatId,\r\n        communityId: chat.communityId\r\n      },\r\n      include: {\r\n        sender: {\r\n          select: {\r\n            id: true,\r\n            name: true,\r\n            image: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    // Emit the new message to all clients in the chat room\r\n    io.to(chatId).emit(\"newMessage\", message);\r\n\r\n    res.status(201).json(message);\r\n  } catch (error) {\r\n    console.error(\"Create Message Error:\", error);\r\n    res.status(500).json({ message: \"Internal server error\" });\r\n  }\r\n};\r\n\r\nexport const getMessagesByChat = async (req: any, res: Response): Promise<void> => {\r\n  try {\r\n    const { chatId } = req.params;\r\n    const userId = req.user.id;\r\n    const page = parseInt(req.query.page as string) || 1;\r\n    const limit = parseInt(req.query.limit as string) || 20;\r\n    const skip = (page - 1) * limit;\r\n\r\n    // Verify the chat exists and user has access\r\n    const chat = await prisma.chat.findUnique({\r\n      where: { id: chatId },\r\n      include: { community: { include: { members: true } } }\r\n    });\r\n\r\n    if (!chat) {\r\n      res.status(404).json({ message: \"Chat not found\" });\r\n      return;\r\n    }\r\n\r\n    const isMember = chat.community.members.some(member => member.userId === userId);\r\n    if (!isMember) {\r\n      res.status(403).json({ message: \"You are not a member of this community\" });\r\n      return;\r\n    }\r\n\r\n    // Get total count of messages\r\n    const total = await prisma.message.count({\r\n      where: { chatId }\r\n    });\r\n\r\n    // Get messages with pagination (most recent first)\r\n    const messages = await prisma.message.findMany({\r\n      where: { chatId },\r\n      orderBy: { createdAt: 'desc' },\r\n      skip,\r\n      take: limit,\r\n      include: {\r\n        sender: {\r\n          select: {\r\n            id: true,\r\n            name: true,\r\n            image: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    res.status(200).json({\r\n      messages,\r\n      total,\r\n      hasMore: total > skip + limit,\r\n      page,\r\n      limit\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get Messages Error:\", error);\r\n    res.status(500).json({ message: \"Internal server error\" });\r\n  }\r\n};\r\n\r\nexport const updateMessage = async (req: any, res: Response): Promise<void> => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { content } = req.body;\r\n    const userId = req.user.id;\r\n\r\n    if (!content) {\r\n      res.status(400).json({ message: \"Content is required\" });\r\n      return;\r\n    }\r\n\r\n    // Find the message\r\n    const message = await prisma.message.findUnique({\r\n      where: { id },\r\n      include: { chat: true }\r\n    });\r\n\r\n    if (!message) {\r\n      res.status(404).json({ message: \"Message not found\" });\r\n      return;\r\n    }\r\n\r\n    // Verify the user is the sender\r\n    if (message.senderId !== userId) {\r\n      res.status(403).json({ message: \"You can only edit your own messages\" });\r\n      return;\r\n    }\r\n\r\n    // Update the message\r\n    const updatedMessage = await prisma.message.update({\r\n      where: { id },\r\n      data: { content },\r\n      include: {\r\n        sender: {\r\n          select: {\r\n            id: true,\r\n            name: true,\r\n            image: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    // Emit the updated message to all clients in the chat room\r\n    if (message.chatId) {\r\n      io.to(message.chatId).emit(\"messageUpdated\", updatedMessage);\r\n    }\r\n\r\n    res.status(200).json(updatedMessage);\r\n  } catch (error) {\r\n    console.error(\"Update Message Error:\", error);\r\n    res.status(500).json({ message: \"Internal server error\" });\r\n  }\r\n};\r\n\r\nexport const deleteMessage = async (req: any, res: Response): Promise<void> => {\r\n  try {\r\n    const { id } = req.params;\r\n    const userId = req.user.id;\r\n\r\n    // Find the message\r\n    const message = await prisma.message.findUnique({\r\n      where: { id },\r\n      include: { chat: true }\r\n    });\r\n\r\n    if (!message) {\r\n      res.status(404).json({ message: \"Message not found\" });\r\n      return;\r\n    }\r\n\r\n    // Verify the user is the sender\r\n    if (message.senderId !== userId) {\r\n      res.status(403).json({ message: \"You can only delete your own messages\" });\r\n      return;\r\n    }\r\n\r\n    // Save the chatId before deleting\r\n    const chatId = message.chatId;\r\n\r\n    // Delete the message\r\n    await prisma.message.delete({\r\n      where: { id }\r\n    });\r\n\r\n    // Emit deletion event to all clients in the chat room\r\n    if (chatId) {\r\n      io.to(chatId).emit(\"messageDeleted\", { id });\r\n    }\r\n\r\n    res.status(200).json({ message: \"Message deleted successfully\" });\r\n  } catch (error) {\r\n    console.error(\"Delete Message Error:\", error);\r\n    res.status(500).json({ message: \"Internal server error\" });\r\n  }\r\n};\r\n","import express from \"express\";\r\nimport { \r\n  createChat,\r\n  getCommunityChats,\r\n  getChatById,\r\n  deleteChat\r\n} from \"@/controllers/chat.controller\";\r\nimport {\r\n  createMessage,\r\n  getMessagesByChat,\r\n  updateMessage,\r\n  deleteMessage\r\n} from \"@/controllers/message.controller\";\r\nimport { isLoggedIn } from \"@/middleware/isUserLoggedIn\";\r\n\r\nconst router = express.Router();\r\n\r\n// Chat room routes with authentication\r\nrouter.post(\"/\", isLoggedIn, createChat);\r\nrouter.get(\"/community/:communityId\", isLoggedIn, getCommunityChats);\r\nrouter.get(\"/:chatId\", isLoggedIn, getChatById);\r\nrouter.delete(\"/:chatId\", isLoggedIn, deleteChat);\r\n\r\n// Message routes with authentication\r\nrouter.post(\"/messages\", isLoggedIn, createMessage);\r\nrouter.get(\"/:chatId/messages\", isLoggedIn, getMessagesByChat);\r\nrouter.patch(\"/messages/:id\", isLoggedIn, updateMessage);\r\nrouter.delete(\"/messages/:id\", isLoggedIn, deleteMessage);\r\n\r\nexport default router;\r\n","import express, { Request, Response, NextFunction } from \"express\";\r\nimport cookieParser from \"cookie-parser\";\r\nimport cors from \"cors\";\r\nimport userRouter from \"@/routes/user.route\";\r\nimport communityRouter from \"@/routes/community.route\";\r\nimport chatRouter from \"@/routes/chat.route\";\r\nimport path from \"path\";\r\nimport dotenv from \"dotenv\";\r\n\r\n// Configure dotenv to load .env file\r\ndotenv.config({ path: path.resolve(process.cwd(), \".env\") });\r\n\r\n// Create Express app\r\nconst app = express();\r\n\r\n// Middleware\r\napp.use(express.json());\r\napp.use(cookieParser());\r\napp.use(cors({\r\n  origin: process.env.NODE_ENV === 'development' ? 'http://localhost:3000' : process.env.FRONTEND_URL,\r\n  credentials: true\r\n}));\r\n\r\n// Health check route\r\napp.get(\"/\", (_, res) => {\r\n  res.send(\"API is running...\");\r\n});\r\n\r\n// Routes\r\napp.use(\"/api/user\", userRouter);\r\napp.use(\"/api/communities\", communityRouter);\r\napp.use(\"/api/chats\", chatRouter);\r\n\r\n// Error handler middleware\r\napp.use((err: Error, req: Request, res: Response, next: NextFunction) => {\r\n  console.error('Server Error:', err);\r\n  res.status(500).json({\r\n    message: \"Internal server error\",\r\n    error: process.env.NODE_ENV === 'development' ? err.message : undefined\r\n  });\r\n});\r\n\r\n// Handle 404 errors\r\napp.use((req: Request, res: Response) => {\r\n  res.status(404).json({ message: `Route ${req.url} not found` });\r\n});\r\n\r\nexport default app;\r\n","import dotenv from \"dotenv\";\r\nimport path from \"path\";\r\nimport http from \"http\";\r\nimport app from \"./app\";\r\nimport { initSocketServer } from \"./services/socket\";\r\nimport { prisma, checkDatabaseConnection } from \"./utils/prisma\";\r\n\r\n// Configure dotenv to load .env file\r\ndotenv.config({ path: path.resolve(process.cwd(), \".env\") });\r\n\r\nif (!process.env.JWT_SECRET) {\r\n  console.error(\"Critical environment variable JWT_SECRET is missing!\");\r\n  console.error(\"Please check your .env file\");\r\n  process.exit(1);\r\n}\r\n\r\nconst PORT = parseInt(process.env.PORT || \"8000\", 10);\r\n\r\n// Create HTTP server\r\nconst server = http.createServer(app);\r\n\r\n// Initialize Socket.IO with the server\r\ninitSocketServer(server);\r\n\r\n// Perform initial database connection check with retry\r\nconst MAX_RETRIES = 5;\r\nconst RETRY_INTERVAL = 5000;\r\n\r\nconst connectWithRetry = async (retryCount = 0): Promise<void> => {\r\n  try {\r\n    const isConnected = await checkDatabaseConnection();\r\n    if (isConnected) {\r\n      console.log('Database connection successful');\r\n      // Start the server only after successful DB connection\r\n      server.listen(PORT, () => {\r\n        console.log(`Server running on port ${PORT}`);\r\n        console.log(`Socket.IO server running alongside HTTP server`);\r\n      });\r\n    } else {\r\n      throw new Error('Database connection check failed');\r\n    }\r\n  } catch (error) {\r\n    console.error(`Database connection attempt ${retryCount + 1} failed:`, error);\r\n    if (retryCount < MAX_RETRIES) {\r\n      console.log(`Retrying in ${RETRY_INTERVAL/1000} seconds...`);\r\n      setTimeout(() => connectWithRetry(retryCount + 1), RETRY_INTERVAL);\r\n    } else {\r\n      console.error('Max connection attempts reached. Starting server in offline mode...');\r\n      server.listen(PORT, () => {\r\n        console.log(`Server running on port ${PORT} (Database unavailable)`);\r\n      });\r\n    }\r\n  }\r\n};\r\n\r\n// Start connection process\r\nconnectWithRetry();\r\n\r\n// Handle graceful shutdown\r\nconst gracefulShutdown = async () => {\r\n  console.log('Shutting down gracefully...');\r\n  \r\n  // Close the HTTP server first\r\n  server.close(() => {\r\n    console.log('HTTP server closed.');\r\n    \r\n    // Then disconnect from the database\r\n    prisma.$disconnect()\r\n      .then(() => {\r\n        console.log('Database connection closed.');\r\n        process.exit(0);\r\n      })\r\n      .catch(error => {\r\n        console.error('Error during database disconnection:', error);\r\n        process.exit(1);\r\n      });\r\n  });\r\n  \r\n  // If server hasn't closed within 10 seconds, force shutdown\r\n  setTimeout(() => {\r\n    console.error('Could not close connections in time, forcefully shutting down');\r\n    process.exit(1);\r\n  }, 10000);\r\n};\r\n\r\n// Handle unhandled promise rejections\r\nprocess.on('unhandledRejection', (reason: Error) => {\r\n  console.error('Unhandled Rejection:', reason.message);\r\n});\r\n\r\n// Listen for termination signals\r\nprocess.on('SIGTERM', gracefulShutdown);\r\nprocess.on('SIGINT', gracefulShutdown);\r\n"]}